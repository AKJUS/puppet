#!/bin/bash
set -e
set -u
FORCE=0
PRIVATE=0
CHANGES=0

function log  {
    echo "$@"
}

function puppet_updates {
    cd /etc/puppet
    /usr/bin/git remote update
    LOCAL=$(/usr/bin/git rev-parse @)
    REMOTE=$(/usr/bin/git rev-parse @{u})
    if [ $LOCAL = $REMOTE ]; then
        CHANGES=0
    else
        CHANGES=1
    fi
}

function ssh_agent {
    if [[ -z $(ps -ef | grep ssh-agent | grep -v grep) ]]
    then
       echo "ssh-agent is not running."
    else
       echo "ssh-agent is running. Killing ssh-agent."
       killall ssh-agent
    fi
}

function pull_private {
    ssh_agent
    eval `ssh-agent` && /usr/bin/ssh-add /root/id_rsa && cd /root/private && /usr/bin/git pull
}

function run_puppet {
    cd /etc/puppet
    /usr/bin/git pull
    /usr/bin/puppet apply /etc/puppet/manifests/site.pp -tv
}


function usage {
    echo "Usage: $0 [-f][-p]"; exit 1;
}

while getopts "fp:" option; do
    case $option in
        f)
            FORCE=1
            ;;
        p)
            PRIVATE=1
            ;;
        *)
            usage
            ;;
esac
done

puppet_updates

if [ $CHANGES -eq 1 ]; then
    log "Changes exist!"
    pull_private
    run_puppet
elif [ $FORCE -eq 1 ]; then
    log "Forcing puppet run!"
    pull_private
    run_puppet
else
    log "No changes and no forced run!"
fi;
