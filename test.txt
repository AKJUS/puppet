diff --git a/modules/icinga2/.fixtures.puppet3.yml b/modules/icinga2/.fixtures.puppet3.yml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/.fixtures.yml b/modules/icinga2/.fixtures.yml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/.gitignore b/modules/icinga2/.gitignore
old mode 100644
new mode 100755
index 8912186e..bb61d658
--- a/modules/icinga2/.gitignore
+++ b/modules/icinga2/.gitignore
@@ -14,4 +14,6 @@ pkg/
 Gemfile.lock
 /.ruby-*
 .bundle
+.vendor/
 vendor/
+log/
diff --git a/modules/icinga2/.mailmap b/modules/icinga2/.mailmap
old mode 100644
new mode 100755
diff --git a/modules/icinga2/.travis.yml b/modules/icinga2/.travis.yml
old mode 100644
new mode 100755
index f88d2749..8cf2512a
--- a/modules/icinga2/.travis.yml
+++ b/modules/icinga2/.travis.yml
@@ -7,8 +7,6 @@ cache: bundler
 before_install:
   - bundle -v
   - rm Gemfile.lock || true
-  - gem update --system
-  - gem update bundler
   - gem --version
   - bundle -v
 script:
diff --git a/modules/icinga2/AUTHORS b/modules/icinga2/AUTHORS
old mode 100644
new mode 100755
index 9583da41..b9b9f5b4
--- a/modules/icinga2/AUTHORS
+++ b/modules/icinga2/AUTHORS
@@ -1,6 +1,7 @@
 Alan Jenkins <alan.christopher.jenkins@gmail.com>
 Alessandro Lorenzi <alessandro@lm-net.it>
 Alexander Schaber <alexander@schaber.info>
+Andrea Cervesato <andrea.cervesato@kqi.it>
 Andreas Ntaflos <andreas.ntaflos@rise-world.com>
 Andreas Paul <xorpaul@gmail.com>
 Blerim Sheqa <blerim.sheqa@icinga.com>
@@ -11,6 +12,7 @@ Florian Baumann <flo@noqqe.de>
 Gunnar Beutner <gunnar.beutner@netways.de>
 James Fryman <james@fryman.io>
 Jan-Otto Kröpke <kroepke@outlook.com>
+Jerome Charaoui <jcharaoui@cmaisonneuve.qc.ca>
 Lennart Betz <lennart.betz@netways.de>
 Markus Frosch <markus.frosch@icinga.com>
 Matthias Ritter <matthias.ritter@dm.de>
@@ -21,6 +23,9 @@ Rudy Gevaert <rudy.gevaert@ugent.be>
 Simon Hoenscheid <simon.hoenscheid@netways.de>
 Stefan Kleindl <stefan.kleindl@rise-world.com>
 Thomas Dalichow <thomas.dalichow@publicispixelpark.de>
+Till Adam <till.adam@dm.de>
 Tom De Vylder <tom@penumbra.be>
 Tomas Barton <barton.tomas@gmail.com>
+Wyatt Alt <wyatt.alt@gmail.com>
 Zach Leslie <xaque208@gmail.com>
+murmur <hristo.mohamed@gmail.com>
diff --git a/modules/icinga2/CHANGELOG.md b/modules/icinga2/CHANGELOG.md
old mode 100644
new mode 100755
index f6c8bfeb..2507aade
--- a/modules/icinga2/CHANGELOG.md
+++ b/modules/icinga2/CHANGELOG.md
@@ -1,5 +1,75 @@
 # Change Log
 
+## [v1.3.6](https://github.com/Icinga/puppet-icinga2/tree/v1.3.6) (2018-04-25)
+[Full Changelog](https://github.com/Icinga/puppet-icinga2/compare/v1.3.5...v1.3.6)
+
+**Implemented enhancements:**
+
+- Add support for SLC6 Linux [\#441](https://github.com/Icinga/puppet-icinga2/pull/441) ([HristoMohamed](https://github.com/HristoMohamed))
+- Support manage\_repo on XenServer [\#436](https://github.com/Icinga/puppet-icinga2/pull/436) ([jcharaoui](https://github.com/jcharaoui))
+
+**Fixed bugs:**
+
+- Changes on concat resource for objects does not trigger a refresh on puppet3 [\#434](https://github.com/Icinga/puppet-icinga2/issues/434)
+- don't quote null  [\#433](https://github.com/Icinga/puppet-icinga2/issues/433)
+
+**Closed issues:**
+
+- Using apply in a service causes service\_name not to be applied to service leading to duplicate resource issues [\#429](https://github.com/Icinga/puppet-icinga2/issues/429)
+- Applying services to hostgroups [\#427](https://github.com/Icinga/puppet-icinga2/issues/427)
+
+**Merged pull requests:**
+
+- Bug/do not quote null 433 [\#435](https://github.com/Icinga/puppet-icinga2/pull/435) ([lbetz](https://github.com/lbetz))
+
+## [v1.3.5](https://github.com/Icinga/puppet-icinga2/tree/v1.3.5) (2018-01-24)
+[Full Changelog](https://github.com/Icinga/puppet-icinga2/compare/v1.3.4...v1.3.5)
+
+**Implemented enhancements:**
+
+- icinga2 binary is wrong on rhel5 [\#409](https://github.com/Icinga/puppet-icinga2/issues/409)
+- Add feature Elasticsearch [\#408](https://github.com/Icinga/puppet-icinga2/issues/408)
+- Add feature elasticsearch [\#399](https://github.com/Icinga/puppet-icinga2/issues/399)
+- Added cloudlinux to supported operating systems. Is nearly identical … [\#424](https://github.com/Icinga/puppet-icinga2/pull/424) ([koma85](https://github.com/koma85))
+
+**Fixed bugs:**
+
+- Setting up icinga2 with a different port than default for idodb leads to an error  [\#411](https://github.com/Icinga/puppet-icinga2/issues/411)
+- fix \#411 Setting up Icinga 2 with a different port than default for i… [\#413](https://github.com/Icinga/puppet-icinga2/pull/413) ([lbetz](https://github.com/lbetz))
+- fix for repository.d directory on master-systems [\#412](https://github.com/Icinga/puppet-icinga2/pull/412) ([matthiasritter](https://github.com/matthiasritter))
+
+**Closed issues:**
+
+- escaping broken with double quotes? [\#416](https://github.com/Icinga/puppet-icinga2/issues/416)
+- Icinga resource doesn't create ca directory and required files [\#415](https://github.com/Icinga/puppet-icinga2/issues/415)
+- icinga2 option generates self signed certificates that are rejected by master [\#405](https://github.com/Icinga/puppet-icinga2/issues/405)
+- manage repo trough proxy [\#394](https://github.com/Icinga/puppet-icinga2/issues/394)
+
+**Merged pull requests:**
+
+- trivial copy edits [\#420](https://github.com/Icinga/puppet-icinga2/pull/420) ([wkalt](https://github.com/wkalt))
+- Fix confd example path [\#417](https://github.com/Icinga/puppet-icinga2/pull/417) ([dnsmichi](https://github.com/dnsmichi))
+- fix \#409 icinga2 binary is wrong on rhel5 [\#410](https://github.com/Icinga/puppet-icinga2/pull/410) ([lbetz](https://github.com/lbetz))
+
+## [v1.3.4](https://github.com/Icinga/puppet-icinga2/tree/v1.3.4) (2017-11-22)
+[Full Changelog](https://github.com/Icinga/puppet-icinga2/compare/v1.3.3...v1.3.4)
+
+**Fixed bugs:**
+
+- repository.d missing after install [\#403](https://github.com/Icinga/puppet-icinga2/issues/403)
+- Boolean 'false' custom variables do not appear in configuration [\#400](https://github.com/Icinga/puppet-icinga2/issues/400)
+- $bin\_dir path incorrect for FreeBSD in params.pp [\#396](https://github.com/Icinga/puppet-icinga2/issues/396)
+
+**Closed issues:**
+
+- missing /etc/pki directory [\#393](https://github.com/Icinga/puppet-icinga2/issues/393)
+
+**Merged pull requests:**
+
+- fix \#400 boolean false custom variables do not appear in configuration [\#406](https://github.com/Icinga/puppet-icinga2/pull/406) ([lbetz](https://github.com/lbetz))
+- Bug/repository.d missing after install 403 [\#404](https://github.com/Icinga/puppet-icinga2/pull/404) ([lbetz](https://github.com/lbetz))
+- fix \#396 incorrect bin\_dir path for FreeBSD [\#401](https://github.com/Icinga/puppet-icinga2/pull/401) ([lbetz](https://github.com/lbetz))
+
 ## [v1.3.3](https://github.com/Icinga/puppet-icinga2/tree/v1.3.3) (2017-10-24)
 [Full Changelog](https://github.com/Icinga/puppet-icinga2/compare/v1.3.2...v1.3.3)
 
@@ -500,4 +570,4 @@
 ## [v0.6.1](https://github.com/Icinga/puppet-icinga2/tree/v0.6.1) (2014-12-03)
 
 
-\* *This Change Log was automatically generated by [github_changelog_generator](https://github.com/skywinder/Github-Changelog-Generator)*
\ No newline at end of file
+\* *This Change Log was automatically generated by [github_changelog_generator](https://github.com/skywinder/Github-Changelog-Generator)*
diff --git a/modules/icinga2/CONTRIBUTING.md b/modules/icinga2/CONTRIBUTING.md
old mode 100644
new mode 100755
diff --git a/modules/icinga2/Gemfile b/modules/icinga2/Gemfile
old mode 100644
new mode 100755
diff --git a/modules/icinga2/LICENSE b/modules/icinga2/LICENSE
old mode 100644
new mode 100755
diff --git a/modules/icinga2/README.md b/modules/icinga2/README.md
old mode 100644
new mode 100755
index e580260b..ecaf9bb9
--- a/modules/icinga2/README.md
+++ b/modules/icinga2/README.md
@@ -23,6 +23,11 @@
 Icinga 2 is a widely used open source monitoring software. This Puppet module helps with installing and managing
 configuration of Icinga 2 on multiple operating systems.
 
+### Notices
+
+For Icinga 2 v2.8.0 and higher version v1.3.4 and above is needed and the parameter repositoryd
+can set to false. See issue #403.
+
 ## Module Description
 
 This module installs and configures Icinga 2 on your Linux or Windows hosts.
@@ -50,8 +55,8 @@ available in Icinga 2 can be enabled and configured with this module.
 
 This module depends on:
 
-* [puppetlabs/stdlib] >= 4.10.0
-* [puppetlabs/concat] >= 2.0.1
+* [puppetlabs/stdlib] >= 4.16.0
+* [puppetlabs/concat] >= 2.1.0
 
 Depending on your setup following modules may also be required:
 
@@ -160,7 +165,7 @@ Depending on your database you need to enable the feature `icinga2::feature::ido
 Both features are capable of importing the base schema into the database, however this is disabled by default.
 Updating the database schema to another version is currently not supported.
 
-The IDO features require a pre-existing database and an user with permissions to create schema, and edit data
+The IDO features require a pre-existing database and a user with permissions to create schema and edit data.
 
 #### MySQL
 
@@ -229,7 +234,7 @@ sends configurations over the Icinga 2 protocol to satellites and/or clients.
 
 More detailed examples can be found in the [examples] directory.
 
-Ths examples creates the configuration for a master that has one satellite connected. A global zone is created for
+This example creates the configuration for a master that has one satellite connected. A global zone is created for
 templates, and all features of a typical master are enabled.
 
 ``` puppet
@@ -273,8 +278,8 @@ A satellite has a parent zone and one or multiple child zones. Satellites are us
 monitoring load or to reach delimited zones in the network. A satellite either executes checks itself or delegates them
 to a client.
 
-The satellite has less features enabled, but executes checks similar to a master. It connects to a master zone, and to
-and satellite or client below in the hierarchy. As parent acts either the master zone, or another satellite zone.
+The satellite has fewer features enabled, but executes checks similar to a master. It connects to a master zone, and to
+a satellite or client below in the hierarchy. As parent acts either the master zone, or another satellite zone.
 
 ``` puppet
 class { '::icinga2':
@@ -526,9 +531,11 @@ monitoring::defaults:
 
 ### Apply Rules
 
-Some objects support to be applied to other objects. To create a simple apply rule you must set the `apply` parameter to
-`true`. If this parameter is set to a string, this string will be used to build an `apply for` loop. A service object
-always targets a host object. All other objects need to explicitly set an `apply_target`
+Some objects can be applied to other objects. To create a simple apply rule you
+must set the `apply` parameter to `true`. If this parameter is set to a string,
+this string will be used to build an `apply for` loop. A service object always
+targets a host object. All other objects need to explicitly set an
+`apply_target`
 
 Apply a SSH service to all Linux hosts:
 
@@ -584,8 +591,8 @@ requires SSL/TLS client certificates. This module offers multiple choices to con
 
 #### CA on your Icinga Master
 
-One of your Icinga master needs to behave as a CA. With the class `icinga2::pki::ca` you can do following to fulfil
-this requirement:
+One of your Icinga masters needs to behave as a CA. With the class
+`icinga2::pki::ca` you can do the following to fulfill this requirement:
 
 * Use the the `icinga2` CLI to generate a complete new CA
 ``` puppet
@@ -618,7 +625,7 @@ file { '/var/lib/icinga2/ca/ca.key':
 ```
 
 * Create a new CA with the `icinga2` CLI command and a certificate signed by this new CA. This is useful especially when
-seting up a new Icinga 2 master.
+setting up a new Icinga 2 master.
 ```puppet
 class { '::icinga2':
   constants => {
@@ -643,7 +650,7 @@ class { '::icinga2::feature::api':
 }
 ```
 
-If you are looking for an option to use your Puppet CA, have a look to the
+If you are looking for an option to use your Puppet CA, have a look at the
 [Client/Satellite Certificates](#clientsatellite-certificates) section.
 
 #### Client/Satellite Certificates
@@ -656,7 +663,7 @@ instances. This module offers following options to create these certificates:
 include ::icinga2::feature::api
 ```
 
-* Use a custom function implemented in this module to generate a certificate. This feature will to the following:
+* Use a custom function implemented in this module to generate a certificate. This feature will do the following:
   * Generate a key and certificate based on the FQDN of the host
   * Save the certificate of another Icinga 2 instance, usually the Icinga master where your Icinga CA is located
   * Generate a ticket based on the TicketSalt
@@ -879,6 +886,10 @@ set this parameter to `false`. By default this parameter is `true`. It's also po
 own directory. This directory and must be managed outside of this module as file resource
 with tag icinga2::config::file.
 
+##### `repositoryd`
+`repository.d` is removed since Icinga 2 2.8.0, set to true (default) will handle the directory.
+This Parameter will change to false by default in v2.0.0 and will be removed in the future.
+
 #### Class: `icinga2::feature::checker`
 Enables or disables the `checker` feature.
 
diff --git a/modules/icinga2/RELEASE.md b/modules/icinga2/RELEASE.md
old mode 100644
new mode 100755
diff --git a/modules/icinga2/Rakefile b/modules/icinga2/Rakefile
old mode 100644
new mode 100755
diff --git a/modules/icinga2/TESTING.md b/modules/icinga2/TESTING.md
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/apply_service.pp b/modules/icinga2/examples/apply_service.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/README.md b/modules/icinga2/examples/example3/README.md
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/hieradata/common.yaml b/modules/icinga2/examples/example3/hieradata/common.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/hieradata/nodes/icingamaster.yaml b/modules/icinga2/examples/example3/hieradata/nodes/icingamaster.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/hieradata/nodes/webserver.yaml b/modules/icinga2/examples/example3/hieradata/nodes/webserver.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site.pp b/modules/icinga2/examples/example3/site.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/profile/manifests/backuppc/server.pp b/modules/icinga2/examples/example3/site/profile/manifests/backuppc/server.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/profile/manifests/icinga/agent.pp b/modules/icinga2/examples/example3/site/profile/manifests/icinga/agent.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/profile/manifests/icinga/applyrules.pp b/modules/icinga2/examples/example3/site/profile/manifests/icinga/applyrules.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/profile/manifests/icinga/server.pp b/modules/icinga2/examples/example3/site/profile/manifests/icinga/server.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/profile/manifests/nginx.pp b/modules/icinga2/examples/example3/site/profile/manifests/nginx.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/role/manifests/icingamaster.pp b/modules/icinga2/examples/example3/site/role/manifests/icingamaster.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/role/manifests/monitorednode.pp b/modules/icinga2/examples/example3/site/role/manifests/monitorednode.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example3/site/role/manifests/webserver.pp b/modules/icinga2/examples/example3/site/role/manifests/webserver.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/README.md b/modules/icinga2/examples/example4/README.md
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/hiera.yaml b/modules/icinga2/examples/example4/hiera.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/hieradata/Linux.yaml b/modules/icinga2/examples/example4/hieradata/Linux.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/hieradata/example.local.yaml b/modules/icinga2/examples/example4/hieradata/example.local.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/hieradata/example.org.yaml b/modules/icinga2/examples/example4/hieradata/example.org.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/hieradata/nodes/example.domain.org.yaml b/modules/icinga2/examples/example4/hieradata/nodes/example.domain.org.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/hieradata/nodes/slave.example.org.yaml b/modules/icinga2/examples/example4/hieradata/nodes/slave.example.org.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/profile/files/icinga2/templates.conf b/modules/icinga2/examples/example4/profile/files/icinga2/templates.conf
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/profile/manifests/agent.pp b/modules/icinga2/examples/example4/profile/manifests/agent.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/profile/manifests/master.pp b/modules/icinga2/examples/example4/profile/manifests/master.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/profile/manifests/plugins.pp b/modules/icinga2/examples/example4/profile/manifests/plugins.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example4/profile/manifests/slave.pp b/modules/icinga2/examples/example4/profile/manifests/slave.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/example_config.pp b/modules/icinga2/examples/example_config.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/hostgroup.pp b/modules/icinga2/examples/hostgroup.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init.pp b/modules/icinga2/examples/init.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_api.pp b/modules/icinga2/examples/init_api.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_command.pp b/modules/icinga2/examples/init_command.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_confd.pp b/modules/icinga2/examples/init_confd.pp
old mode 100644
new mode 100755
index 89376363..20e13f4f
--- a/modules/icinga2/examples/init_confd.pp
+++ b/modules/icinga2/examples/init_confd.pp
@@ -1,6 +1,6 @@
 class { 'icinga2':
   manage_repo => true,
-  confd       => '/etc/icinga/local.d',
+  confd       => '/etc/icinga2/local.d',
 }
 
 file { '/etc/icinga2/local.d':
diff --git a/modules/icinga2/examples/init_file.pp b/modules/icinga2/examples/init_file.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_idomysql.pp b/modules/icinga2/examples/init_idomysql.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_idopgsql.pp b/modules/icinga2/examples/init_idopgsql.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_influxdb.pp b/modules/icinga2/examples/init_influxdb.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_master.pp b/modules/icinga2/examples/init_master.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_package.pp b/modules/icinga2/examples/init_package.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_package_idomysql.pp b/modules/icinga2/examples/init_package_idomysql.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_package_idopgsql.pp b/modules/icinga2/examples/init_package_idopgsql.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_plugins.pp b/modules/icinga2/examples/init_plugins.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_repo.pp b/modules/icinga2/examples/init_repo.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/init_slave.pp b/modules/icinga2/examples/init_slave.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/objects_from_hiera.pp b/modules/icinga2/examples/objects_from_hiera.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/examples/ticket_id.pp b/modules/icinga2/examples/ticket_id.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/files/commands.conf b/modules/icinga2/files/commands.conf
index 963432a9..790d2be1 100644
--- a/modules/icinga2/files/commands.conf
+++ b/modules/icinga2/files/commands.conf
@@ -1,38 +1,138 @@
 /* Command objects */
 
+/* Command objects */
+
+/* Notification Commands
+ *
+ * Please check the documentation for all required and
+ * optional parameters.
+ */
+
 object NotificationCommand "mail-host-notification" {
   command = [ SysconfDir + "/icinga2/scripts/mail-host-notification.sh" ]
 
-  env = {
-    NOTIFICATIONTYPE = "$notification.type$"
-    HOSTALIAS = "$host.display_name$"
-    HOSTADDRESS = "$address$"
-    HOSTSTATE = "$host.state$"
-    LONGDATETIME = "$icinga.long_date_time$"
-    HOSTOUTPUT = "$host.output$"
-    NOTIFICATIONAUTHORNAME = "$notification.author$"
-    NOTIFICATIONCOMMENT = "$notification.comment$"
-    HOSTDISPLAYNAME = "$host.display_name$"
-    USEREMAIL = "$user.email$"
+  arguments += {
+    "-4" = "$notification_address$"
+    "-6" = "$notification_address6$"
+    "-b" = "$notification_author$"
+    "-c" = "$notification_comment$"
+    "-d" = {
+      required = true
+      value = "$notification_date$"
+    }
+    "-f" = {
+      value = "$notification_from$"
+      description = "Set from address. Requires GNU mailutils (Debian/Ubuntu) or mailx (RHEL/SUSE)"
+    }
+    "-i" = "$notification_icingaweb2url$"
+    "-l" = {
+      required = true
+      value = "$notification_hostname$"
+    }
+    "-n" = {
+      required = true
+      value = "$notification_hostdisplayname$"
+    }
+    "-o" = {
+      required = true
+      value = "$notification_hostoutput$"
+    }
+    "-r" = {
+      required = true
+      value = "$notification_useremail$"
+    }
+    "-s" = {
+      required = true
+      value = "$notification_hoststate$"
+    }
+    "-t" = {
+      required = true
+      value = "$notification_type$"
+    }
+    "-v" = "$notification_logtosyslog$"
+  }
+
+  vars += {
+    notification_address = "$address$"
+    notification_address6 = "$address6$"
+    notification_author = "$notification.author$"
+    notification_comment = "$notification.comment$"
+    notification_type = "$notification.type$"
+    notification_date = "$icinga.long_date_time$"
+    notification_hostname = "$host.name$"
+    notification_hostdisplayname = "$host.display_name$"
+    notification_hostoutput = "$host.output$"
+    notification_hoststate = "$host.state$"
+    notification_useremail = "$user.email$"
   }
 }
 
 object NotificationCommand "mail-service-notification" {
   command = [ SysconfDir + "/icinga2/scripts/mail-service-notification.sh" ]
 
-  env = {
-    NOTIFICATIONTYPE = "$notification.type$"
-    SERVICEDESC = "$service.name$"
-    HOSTALIAS = "$host.display_name$"
-    HOSTADDRESS = "$address$"
-    SERVICESTATE = "$service.state$"
-    LONGDATETIME = "$icinga.long_date_time$"
-    SERVICEOUTPUT = "$service.output$"
-    NOTIFICATIONAUTHORNAME = "$notification.author$"
-    NOTIFICATIONCOMMENT = "$notification.comment$"
-    HOSTDISPLAYNAME = "$host.display_name$"
-    SERVICEDISPLAYNAME = "$service.display_name$"
-    USEREMAIL = "$user.email$"
+  arguments += {
+    "-4" = "$notification_address$"
+    "-6" = "$notification_address6$"
+    "-b" = "$notification_author$"
+    "-c" = "$notification_comment$"
+    "-d" = {
+      required = true
+      value = "$notification_date$"
+    }
+    "-e" = {
+      required = true
+      value = "$notification_servicename$"
+    }
+    "-f" = {
+      value = "$notification_from$"
+      description = "Set from address. Requires GNU mailutils (Debian/Ubuntu) or mailx (RHEL/SUSE)"
+    }
+    "-i" = "$notification_icingaweb2url$"
+    "-l" = {
+      required = true
+      value = "$notification_hostname$"
+    }
+    "-n" = {
+      required = true
+      value = "$notification_hostdisplayname$"
+    }
+    "-o" = {
+      required = true
+      value = "$notification_serviceoutput$"
+    }
+    "-r" = {
+      required = true
+      value = "$notification_useremail$"
+    }
+    "-s" = {
+      required = true
+      value = "$notification_servicestate$"
+    }
+    "-t" = {
+      required = true
+      value = "$notification_type$"
+    }
+    "-u" = {
+      required = true
+      value = "$notification_servicedisplayname$"
+    }
+    "-v" = "$notification_logtosyslog$"
+  }
+
+  vars += {
+    notification_address = "$address$"
+    notification_address6 = "$address6$"
+    notification_author = "$notification.author$"
+    notification_comment = "$notification.comment$"
+    notification_type = "$notification.type$"
+    notification_date = "$icinga.long_date_time$"
+    notification_hostname = "$host.name$"
+    notification_hostdisplayname = "$host.display_name$"
+    notification_servicename = "$service.name$"
+    notification_serviceoutput = "$service.output$"
+    notification_servicestate = "$service.state$"
+    notification_useremail = "$user.email$"
+    notification_servicedisplayname = "$service.display_name$"
   }
 }
 
@@ -44,6 +144,7 @@ object NotificationCommand "irc-host-notification" {
   env = {
     NOTIFICATIONTYPE = "$notification.type$"
     HOSTALIAS = "$host.display_name$"
+    HOSTNAME = "$host.name$"
     HOSTADDRESS = "$address$"
     HOSTSTATE = "$host.state$"
     LONGDATETIME = "$icinga.long_date_time$"
@@ -61,6 +162,7 @@ object NotificationCommand "irc-service-notification" {
   env = {
     NOTIFICATIONTYPE = "$notification.type$"
     SERVICEDESC = "$service.name$"
+    HOSTNAME = "$host.name$"
     HOSTALIAS = "$host.display_name$"
     HOSTADDRESS = "$address$"
     SERVICESTATE = "$service.state$"
@@ -157,13 +259,15 @@ object CheckCommand "check_http" {
   vars.http_sni = false
 }
 
-object EventCommand "create_ssl_phabricator_ticket" {
+object EventCommand "eh_ssl_acme" {
     import "plugin-event-command"
 
-    command = [ SysconfDir + "/icinga2/scripts/create_ssl_phabricator_ticket.sh" ]
+    command = [ SysconfDir + "/icinga2/scripts/ssl-renew.sh" ]
     env = {
       NOTIFICATIONTYPE = "$notification.type$"
       SERVICEDESC = "$service.name$"
+      SERVICEATTEMPT = "$service.check_attempt$"
+      SERVICESTATETYPE = "$service.state_type$"
       HOSTALIAS = "$host.display_name$"
       HOSTADDRESS = "$address$"
       SERVICESTATE = "$service.state$"
diff --git a/modules/icinga2/files/scripts/create_ssl_phabricator_ticket.sh b/modules/icinga2/files/scripts/create_ssl_phabricator_ticket.sh
deleted file mode 100644
index 25735147..00000000
--- a/modules/icinga2/files/scripts/create_ssl_phabricator_ticket.sh
+++ /dev/null
@@ -1,3 +0,0 @@
-#!/bin/sh
-
-/usr/bin/python /etc/icinga2/ssl-phabricator.py -s "$SERVICESTATE" -t "$SERVICESTATETYPE" -a "$SERVICEATTEMPT" -H "$HOSTADDRESS" -D "$SERVICEDESC" -m "$SERVICEOUTPUT"
diff --git a/modules/icinga2/lib/facter/icinga2_puppet.rb b/modules/icinga2/lib/facter/icinga2_puppet.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/lib/puppet/parser/functions/icinga2_attributes.rb b/modules/icinga2/lib/puppet/parser/functions/icinga2_attributes.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/lib/puppet/parser/functions/icinga2_ticket_id.rb b/modules/icinga2/lib/puppet/parser/functions/icinga2_ticket_id.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/lib/puppet_x/icinga2/pbkdf2.rb b/modules/icinga2/lib/puppet_x/icinga2/pbkdf2.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/lib/puppet_x/icinga2/utils.rb b/modules/icinga2/lib/puppet_x/icinga2/utils.rb
old mode 100644
new mode 100755
index 4ba1d2c9..ab13d6e0
--- a/modules/icinga2/lib/puppet_x/icinga2/utils.rb
+++ b/modules/icinga2/lib/puppet_x/icinga2/utils.rb
@@ -86,7 +86,7 @@ module Puppet
 
         def self.value_types(value)
 
-          if value =~ /^\d+\.?\d*[dhms]?$/ || value =~ /^(true|false)$/ || value =~ /^!?(host|service|user)\./ || value =~ /^\{{2}.*\}{2}$/
+          if value =~ /^\d+\.?\d*[dhms]?$/ || value =~ /^(true|false|null)$/ || value =~ /^!?(host|service|user)\./ || value =~ /^\{{2}.*\}{2}$/
             result = value
           else
             if $constants.index { |x| if $hash_attrs.include?(x) then value =~ /^!?(#{x})(\..+$|$)/ else value =~ /^!?#{x}$/ end }
@@ -186,12 +186,14 @@ module Puppet
             else
               if level > 1
                 if level == 3
-                  result += "%s%s = %s\n" % [ prefix, attribute_types(attr), parse(value) ] if value
+                  result += "%s%s = %s\n" % [ prefix, attribute_types(attr), parse(value) ] if value != :nil
+                  #result += "%s%s = %s\n" % [ prefix, attr, parse(value) ] if value != :nil
                 else
-                  result += "%s[\"%s\"] = %s\n" % [ prefix, attribute_types(attr), parse(value) ] if value
+                  result += "%s[\"%s\"] = %s\n" % [ prefix, attribute_types(attr), parse(value) ] if value != :nil
+                  #result += "%s[\"%s\"] = %s\n" % [ prefix, attr, parse(value) ] if value != :nil
                 end
               else
-                result += "%s%s = %s\n" % [ prefix, attr, parse(value) ] if value
+                result += "%s%s = %s\n" % [ prefix, attr, parse(value) ] if value != :nil
               end
             end
           end
diff --git a/modules/icinga2/manifests/config.pp b/modules/icinga2/manifests/config.pp
old mode 100644
new mode 100755
index 4b60e32e..a17b216e
--- a/modules/icinga2/manifests/config.pp
+++ b/modules/icinga2/manifests/config.pp
@@ -20,6 +20,7 @@ class icinga2::config {
   $plugins        = $::icinga2::plugins
   $confd          = $::icinga2::_confd
   $purge_features = $::icinga2::purge_features
+  $repositoryd    = $::icinga2::repositoryd
 
   if $::kernel != 'windows' {
     $template_constants  = icinga2_attributes($constants)
diff --git a/modules/icinga2/manifests/config/fragment.pp b/modules/icinga2/manifests/config/fragment.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/custom/conf.pp b/modules/icinga2/manifests/custom/conf.pp
deleted file mode 100644
index 00f49bb2..00000000
--- a/modules/icinga2/manifests/custom/conf.pp
+++ /dev/null
@@ -1,194 +0,0 @@
-class icinga2::custom::conf {
-    include ::icinga2
-
-    include ::icinga2::feature::api
-
-    include ::icinga2::feature::command
-
-    include ::icinga2::feature::notification
-
-    include ::icinga2::feature::perfdata
-
-    $db_host = hiera('icinga_ido_db_host', 'db4.miraheze.org')
-    $db_name = hiera('icinga_ido_db_name', 'icinga')
-    $db_user = hiera('icinga_ido_user_name', 'icinga2')
-    $db_password = hiera('passwords::icinga_ido')
-
-    class{ '::icinga2::feature::idomysql':
-        host          => $db_host,
-        user          => $db_user,
-        password      => $db_password,
-        database      => $db_name,
-        import_schema => true,
-    }
-
-    file { '/etc/icinga2/conf.d/commands.conf':
-        source  => 'puppet:///modules/icinga2/commands.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0664',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/conf.d/groups.conf':
-        source  => 'puppet:///modules/icinga2/groups.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0664',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/conf.d/hosts.conf':
-        source  => 'puppet:///modules/icinga2/hosts.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0664',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/conf.d/notifications.conf':
-        source  => 'puppet:///modules/icinga2/notifications.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0644',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/conf.d/templates.conf':
-        source  => 'puppet:///modules/icinga2/templates.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0644',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/conf.d/timeperiods.conf':
-        source  => 'puppet:///modules/icinga2/timeperiods.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0664',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/conf.d/users.conf':
-        source  => 'puppet:///modules/icinga2/users.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0644',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/features-available/checker.conf':
-        source  => 'puppet:///modules/icinga2/checker.conf',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0644',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { 'features-enabled-checker.conf':
-        path => '/etc/icinga2/features-enabled/checker.conf',
-        ensure  => 'link',
-        target  => '/etc/icinga2/features-available/checker.conf',
-        require => File['/etc/icinga2/features-available/checker.conf'],
-    }
-
-    file { '/etc/icinga2/scripts/irc-host-notification.sh':
-        source  => 'puppet:///modules/icinga2/scripts/irc-host-notification.sh',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0755',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/scripts/irc-service-notification.sh':
-        source  => 'puppet:///modules/icinga2/scripts/irc-service-notification.sh',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0755',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    file { '/etc/icinga2/scripts/create_ssl_phabricator_ticket.sh':
-        source  => 'puppet:///modules/icinga2/scripts/create_ssl_phabricator_ticket.sh',
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0755',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    $ssl = loadyaml('/etc/puppet/ssl/certs.yaml')
-    $redirects = loadyaml('/etc/puppet/ssl/redirects.yaml')
-    $sslcerts = merge( $ssl, $redirects )
-
-    file { '/etc/icinga2/conf.d/ssl.conf':
-        ensure  => 'present',
-        content => template('icinga2/ssl.conf'),
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0664',
-        require => Package['icinga2'],
-        notify  => Service['icinga2'],
-    }
-
-    $icingabot_password = hiera('passwords::phabricator::icinga')
-
-    file { '/etc/icinga2/ssl-phabricator.py':
-        ensure  => 'present',
-        content => template('icinga2/ssl-phabricator.py'),
-        owner   => 'root',
-        group   => 'root',
-        mode    => '0755',
-    }
-
-    package { 'nagios-nrpe-plugin':
-        ensure => present,
-    }
-
-    include ::icingaweb2
-
-    $mirahezebots_password = hiera('passwords::irc::mirahezebots')
-
-    file { '/etc/icinga2/irc.py':
-        ensure  => present,
-        owner   => 'irc',
-        content => template('icinga2/bot/irc.py'),
-        mode    => '0551',
-        notify  => Service['icingabot'],
-    }
-
-    exec { 'Icingabot reload systemd':
-        command     => '/bin/systemctl daemon-reload',
-        refreshonly => true,
-    }
-
-    file { '/etc/systemd/system/icingabot.service':
-        ensure => present,
-        source => 'puppet:///modules/icinga2/bot/icingabot.systemd',
-        notify => Exec['Icingabot reload systemd'],
-    }
-
-    service { 'icingabot':
-        ensure => running,
-    }
-
-    # Purge unmanaged icinga2::object::host and icinga2::object::service resources
-    # This will only happen for non exported resources, that is resources that
-    # are declared by the icinga host itself
-    # resources { 'icinga2::object::host': purge => true, }
-    # resources { 'icinga2::object::service': purge => true, }
-
-    Icinga2::Object::Host <<||>> ~> Service['icinga2']
-    Icinga2::Object::Service <<||>> ~> Service['icinga2']
-}
diff --git a/modules/icinga2/manifests/custom/hosts.pp b/modules/icinga2/manifests/custom/hosts.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/custom/services.pp b/modules/icinga2/manifests/custom/services.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/debian/dbconfig.pp b/modules/icinga2/manifests/debian/dbconfig.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature.pp b/modules/icinga2/manifests/feature.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/api.pp b/modules/icinga2/manifests/feature/api.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/checker.pp b/modules/icinga2/manifests/feature/checker.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/command.pp b/modules/icinga2/manifests/feature/command.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/compatlog.pp b/modules/icinga2/manifests/feature/compatlog.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/debuglog.pp b/modules/icinga2/manifests/feature/debuglog.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/gelf.pp b/modules/icinga2/manifests/feature/gelf.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/graphite.pp b/modules/icinga2/manifests/feature/graphite.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/idomysql.pp b/modules/icinga2/manifests/feature/idomysql.pp
old mode 100644
new mode 100755
index 9e77c0f6..714975a0
--- a/modules/icinga2/manifests/feature/idomysql.pp
+++ b/modules/icinga2/manifests/feature/idomysql.pp
@@ -338,8 +338,8 @@ class icinga2::feature::idomysql(
     exec { 'idomysql-import-schema':
       user    => 'root',
       path    => $::path,
-      command => "mysql -h '${host}' -u '${user}' -p'${password}' '${database}' < '${ido_mysql_schema_dir}/mysql.sql'",
-      unless  => "mysql -h '${host}' -u '${user}' -p'${password}' '${database}' -Ns -e 'select version from icinga_dbversion'",
+      command => "mysql -h '${host}' -P '${port}' -u '${user}' -p'${password}' '${database}' < '${ido_mysql_schema_dir}/mysql.sql'",
+      unless  => "mysql -h '${host}' -P '${port}' -u '${user}' -p'${password}' '${database}' -Ns -e 'select version from icinga_dbversion'",
     }
   }
 
diff --git a/modules/icinga2/manifests/feature/idopgsql.pp b/modules/icinga2/manifests/feature/idopgsql.pp
old mode 100644
new mode 100755
index 2e9cc172..c5ecf86a
--- a/modules/icinga2/manifests/feature/idopgsql.pp
+++ b/modules/icinga2/manifests/feature/idopgsql.pp
@@ -156,8 +156,8 @@ class icinga2::feature::idopgsql(
       user        => 'root',
       path        => $::path,
       environment => ["PGPASSWORD=${password}"],
-      command     => "psql -h '${host}' -U '${user}' -d '${database}' -w -f ${ido_pgsql_schema_dir}/pgsql.sql",
-      unless      => "psql -h '${host}' -U '${user}' -d '${database}' -w -c 'select version from icinga_dbversion'",
+      command     => "psql -h '${host}' -U '${user}' -p '${port}' -d '${database}' -w -f ${ido_pgsql_schema_dir}/pgsql.sql",
+      unless      => "psql -h '${host}' -U '${user}' -p '${port}' -d '${database}' -w -c 'select version from icinga_dbversion'",
     }
   }
 
diff --git a/modules/icinga2/manifests/feature/influxdb.pp b/modules/icinga2/manifests/feature/influxdb.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/livestatus.pp b/modules/icinga2/manifests/feature/livestatus.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/mainlog.pp b/modules/icinga2/manifests/feature/mainlog.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/notification.pp b/modules/icinga2/manifests/feature/notification.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/opentsdb.pp b/modules/icinga2/manifests/feature/opentsdb.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/perfdata.pp b/modules/icinga2/manifests/feature/perfdata.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/statusdata.pp b/modules/icinga2/manifests/feature/statusdata.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/feature/syslog.pp b/modules/icinga2/manifests/feature/syslog.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/init.pp b/modules/icinga2/manifests/init.pp
old mode 100644
new mode 100755
index e9e6f348..cea4c830
--- a/modules/icinga2/manifests/init.pp
+++ b/modules/icinga2/manifests/init.pp
@@ -1,194 +1,14 @@
 # == Class: icinga2
 #
 # This module installs and configures Icinga 2.
-#
-# === Parameters
-#
-# [*ensure*]
-#   Manages if the service should be stopped or running. Defaults to running.
-#
-# [*enable*]
-#   If set to true the Icinga 2 service will start on boot. Defaults to true.
-#
-# [*manage_repo*]
-#   When set to true this module will install the packages.icinga.com repository. With this official repo you can get
-#   the latest version of Icinga. When set to false the operating systems default will be used. As the Icinga Project
-#   does not offer a Chocolatey repository, you will get a warning if you enable this parameter on Windows.
-#   Defaults to false. NOTE: will be ignored if manage_package is set to false.
-#
-# [*manage_package*]
-#   If set to false packages aren't managed. Defaults to true.
-#
-# [*manage_service*]
-#   If set to true the service is managed otherwise the service also
-#   isn't restarted if a config file changed. Defaults to true.
-#
-# [*features*]
-#   List of features to activate. Defaults to [checker, mainlog, notification].
-#
-# [*purge_features*]
-#   Define if configuration files for features not managed by Puppet should be purged. Defaults to true.
-#
-# [*constants*]
-#   Hash of constants. Defaults are set in the params class. Your settings will be merged with the defaults.
-#
-# [*plugins*]
-#   A list of the ITL plugins to load. Defaults to [ 'plugins', 'plugins-contrib', 'windows-plugins', 'nscp' ].
-#
-# [*confd*]
-#   `conf.d` is the directory where Icinga 2 stores its object configuration by default. To disable it,
-#   set this parameter to `false`. By default this parameter is `true`. It's also possible to assign your
-#   own directory. This directory must be managed outside of this module as file resource
-#   with tag icinga2::config::file.
-#
-# All default parameters are set in the icinga2::params class. To get more technical information have a look into the
-# params.pp manifest.
-#
-# === Variables
-#
-# [*_confd*]
-#   Configuration directory (conf.d).
-#
-# [*_constants*]
-#   Merge parameter constants with defaults from params.
-#
-# === Examples
-#
-# Declare icinga2 with all defaults. Keep in mind that your operating system may not have Icinga 2 in its package
-# repository.
-#
-#  include ::icinga2
-#
-# If you want to use the official Icinga Project repository, enable the manage_repo parameter. Note: On Windows only
-# chocolatey is supported as installation source. The Icinga Project does not offer a chocolatey repository, therefore
-# you will get a warning if you enable this parameter
-# on windows.
-#
-#  class { 'icinga2':
-#    manage_repo => true,
-#  }
-#
-# If you don't want to manage the Icinga 2 service with puppet, you can dissable this behaviour with the manage_service
-# parameter. When set to false no service refreshes will be triggered.
-#
-#  class { 'icinga2':
-#    manage_service => false,
-#  }
-#
-# To manage the version of Icinga 2 binaries you can do it by disable package management.
-#
-#  package { 'icinga2':
-#    ensure    => latest,
-#    notifiy => Class['icinga2'],
-#  }
-#
-#  class { '::icinga2':
-#    manage_package => false,
-#  }
-#
-# Setting manage_package to false means that all package aren't handeld by the module included the IDO packages.
-#
-# Sometimes it's necessary to cover very special configurations that you cannot handle with this module. In this case
-# you can use the icinga2::config::file tag on your file resource. This module collects all file resource types with
-# this tag and triggers a reload of Icinga 2 on a file change.
-#
-#  include ::icinga2
-#  file { '/etc/icinga2/conf.d/foo.conf':
-#    ensure => file,
-#    owner  => icinga,
-#    ...
-#    tag    => 'icinga2::config::file',
-#    ...
-#  }
-#
-# To set constants in etc/icinga2/constants.conf use the constants parameter and as
-# value a hash, every key will be set as constant and assigned by it's value. Defaults
-# can be overwritten.
-#
-#  class { 'icinga2':
-#    ...
-#    constants   => {
-#      'key1'             => 'value1',
-#      'key2'             => 'value2',
-#      'PluginContirbDir' => '/usr/local/nagios/plugins',
-#    }
-#  }
-#
-# The ITL contains several CheckCommand definitions to load, set these in the array
-# of the plugins parameter, i.e. for a master or satellite do the following and
-# disbale the load of the configuration in conf.d.
-#
-#  class { 'icinga':
-#    ...
-#    plugins => [ 'plugins', 'contrib-plugins', 'nscp', 'windows-plugins' ],
-#    confd   => false,
-#  }
-#
-# To use a different directory for your configuration, create the directory
-# as file resource with tag icinga2::config::file.
-#
-#   file { '/etc/icinga2/local.d':
-#     ensure => directory,
-#     tag    => 'icinga2::config::file'
-#   }
-#   class { 'icinga2':
-#     ...
-#     confd => 'local.d',
-#   }
-#
-#
-class icinga2(
-  $ensure         = running,
-  $enable         = true,
-  $manage_repo    = false,
-  $manage_package = true,
-  $manage_service = true,
-  $features       = $icinga2::params::default_features,
-  $purge_features = true,
-  $constants      = {},
-  $plugins        = $icinga2::params::plugins,
-  $confd          = true,
-) inherits ::icinga2::params {
-
-  validate_re($ensure, [ '^running$', '^stopped$' ],
-    "${ensure} isn't supported. Valid values are 'running' and 'stopped'.")
-  validate_bool($enable)
-  validate_bool($manage_repo)
-  validate_bool($manage_package)
-  validate_bool($manage_service)
-  validate_array($features)
-  validate_bool($purge_features)
-  validate_hash($constants)
-  validate_array($plugins)
-
-  # validate confd, boolean or string
-  if is_bool($confd) {
-    if $confd { $_confd = 'conf.d' } else { $_confd = undef }
-  } elsif is_string($confd) {
-    $_confd = $confd
-  } else {
-    fail('confd has to be a boolean or string')
-  }
-
-  # merge constants with defaults
-  $_constants = merge($::icinga2::params::constants, $constants)
-
-  Class['::icinga2::config']
-  -> Concat <| tag == 'icinga2::config::file' |>
-  ~> Class['::icinga2::service']
+class icinga2 {
+    include icinga2::repo
 
-  anchor { '::icinga2::begin':
-    notify => Class['::icinga2::service']
-  }
-  -> class { '::icinga2::repo': }
-  -> class { '::icinga2::install': }
-  -> File <| ensure == 'directory' and tag == 'icinga2::config::file' |>
-  -> class { '::icinga2::config': notify => Class['::icinga2::service'] }
-  -> File <| ensure != 'directory' and tag == 'icinga2::config::file' |>
-  ~> class { '::icinga2::service': }
-  -> anchor { '::icinga2::end':
-    subscribe => Class['::icinga2::config']
-  }
+    if hiera('icinga2_server', false) {
+        include ::icinga2::server
+    }
 
-  include prefix($features, '::icinga2::feature::')
+    if hiera('icinga2_web', false) {
+        include ::icinga2::web
+    }
 }
diff --git a/modules/icinga2/manifests/install.pp b/modules/icinga2/manifests/install.pp
old mode 100644
new mode 100755
index d22d960c..c25454e9
--- a/modules/icinga2/manifests/install.pp
+++ b/modules/icinga2/manifests/install.pp
@@ -22,6 +22,7 @@ class icinga2::install {
   $conf_dir       = $::icinga2::params::conf_dir
   $user           = $::icinga2::params::user
   $group          = $::icinga2::params::group
+  $repositoryd    = $::icinga2::repositoryd
 
   if $manage_package {
     if $::osfamily == 'windows' { Package { provider => chocolatey, } }
@@ -37,5 +38,21 @@ class icinga2::install {
     owner  => $user,
     group  => $group,
   }
-}
 
+  # deprecated, removed in Icinga 2 v2.8.0
+  $_ensure = $repositoryd ? {
+    true    => 'directory',
+    default => 'absent',
+  }
+
+  file { "${conf_dir}/repository.d":
+    ensure  => $_ensure,
+    owner   => $user,
+    group   => $group,
+    recurse => true,
+    purge   => true,
+    force   => true,
+    require => File[$pki_dir, $conf_dir],
+  }
+
+}
diff --git a/modules/icinga2/manifests/object.pp b/modules/icinga2/manifests/object.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/apiuser.pp b/modules/icinga2/manifests/object/apiuser.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/checkcommand.pp b/modules/icinga2/manifests/object/checkcommand.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/checkresultreader.pp b/modules/icinga2/manifests/object/checkresultreader.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/compatlogger.pp b/modules/icinga2/manifests/object/compatlogger.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/dependency.pp b/modules/icinga2/manifests/object/dependency.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/endpoint.pp b/modules/icinga2/manifests/object/endpoint.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/eventcommand.pp b/modules/icinga2/manifests/object/eventcommand.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/host.pp b/modules/icinga2/manifests/object/host.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/hostgroup.pp b/modules/icinga2/manifests/object/hostgroup.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/notification.pp b/modules/icinga2/manifests/object/notification.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/notificationcommand.pp b/modules/icinga2/manifests/object/notificationcommand.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/scheduleddowntime.pp b/modules/icinga2/manifests/object/scheduleddowntime.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/service.pp b/modules/icinga2/manifests/object/service.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/servicegroup.pp b/modules/icinga2/manifests/object/servicegroup.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/timeperiod.pp b/modules/icinga2/manifests/object/timeperiod.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/user.pp b/modules/icinga2/manifests/object/user.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/usergroup.pp b/modules/icinga2/manifests/object/usergroup.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/object/zone.pp b/modules/icinga2/manifests/object/zone.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/params.pp b/modules/icinga2/manifests/params.pp
old mode 100644
new mode 100755
index 0f92c1dc..d96c6626
--- a/modules/icinga2/manifests/params.pp
+++ b/modules/icinga2/manifests/params.pp
@@ -102,6 +102,7 @@ class icinga2::params {
           $user    = 'icinga'
           $group   = 'icinga'
           $bin_dir = $::operatingsystemmajrelease ? {
+            '5'     => '/usr/sbin',
             '6'     => '/usr/sbin',
             default => '/sbin',
           }
@@ -169,7 +170,7 @@ class icinga2::params {
     } # Windows
 
     'FreeBSD': {
-      $bin_dir              = '/usr/local/sbin/icinga2'
+      $bin_dir              = '/usr/local/sbin'
       $conf_dir             = '/usr/local/etc/icinga2'
       $log_dir              = '/var/log/icinga2'
       $run_dir              = '/var/run/icinga2'
diff --git a/modules/icinga2/manifests/pki/ca.pp b/modules/icinga2/manifests/pki/ca.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/manifests/repo.pp b/modules/icinga2/manifests/repo.pp
old mode 100644
new mode 100755
index b0a4da63..d12cdfa2
--- a/modules/icinga2/manifests/repo.pp
+++ b/modules/icinga2/manifests/repo.pp
@@ -1,115 +1,25 @@
 # == Class: icinga2::repo
 #
-# This class manages the packages.icinga.com repository based on the operating system. Windows is not supported, as the
-# Icinga Project does not offer a chocolate repository.
-#
-# === Parameters
-#
-# This class does not provide any parameters.
-# To control the behaviour of this class, have a look at the parameters:
-# * icinga2::manage_repo
-#
-# === Examples
-#
-# This class is private and should not be called by others than this module.
-#
-#
+# This class manages the packages.icinga.com repository based on the operating system.
 class icinga2::repo {
-
-  assert_private()
-
-  if $::icinga2::manage_repo and $::icinga2::manage_package {
-
-    case $::osfamily {
-      'redhat': {
-        case $::operatingsystem {
-          'centos', 'redhat', 'oraclelinux': {
-            yumrepo { 'icinga-stable-release':
-              baseurl  => "http://packages.icinga.com/epel/${::operatingsystemmajrelease}/release/",
-              descr    => 'ICINGA (stable release for epel)',
-              enabled  => 1,
-              gpgcheck => 1,
-              gpgkey   => 'http://packages.icinga.com/icinga.key',
-            }
-          }
-          default: {
-            fail('Your plattform is not supported to manage a repository.')
-          }
-        }
-      }
-      'debian': {
-        # handle icinga stable repo before all package resources
-        # contain class problem!
-        Apt::Source['icinga-stable-release'] -> Package <| tag == 'icinga2' |>
-        case $::operatingsystem {
-          'debian': {
-            include ::apt, ::apt::backports
-            apt::source { 'icinga-stable-release':
-              location => 'http://packages.icinga.com/debian',
-              release  => "icinga-${::lsbdistcodename}",
-              repos    => 'main',
-              key      => {
-                id     => 'F51A91A5EE001AA5D77D53C4C6E319C334410682',
-                source => 'http://packages.icinga.com/icinga.key',
-              },
-              require  => Class['::apt::backports'],
-            }
-          }
-          'ubuntu': {
-            include ::apt
-            apt::source { 'icinga-stable-release':
-              location => 'http://packages.icinga.com/ubuntu',
-              release  => "icinga-${::lsbdistcodename}",
-              repos    => 'main',
-              key      => {
-                id     => 'F51A91A5EE001AA5D77D53C4C6E319C334410682',
-                source => 'http://packages.icinga.com/icinga.key',
-              };
-            }
-          }
-          default: {
-            fail('Your plattform is not supported to manage a repository.')
-          }
-        }
-        contain ::apt::update
-      }
-      'suse': {
-
-        file { '/etc/pki/GPG-KEY-icinga':
-          ensure => present,
+    include ::apt, ::apt::backports
+
+    apt::source { 'icinga-stable-release':
+        location => 'http://packages.icinga.com/debian',
+        release  => "icinga-${::lsbdistcodename}",
+        repos    => 'main',
+        key      => {
+          id     => 'F51A91A5EE001AA5D77D53C4C6E319C334410682',
           source => 'http://packages.icinga.com/icinga.key',
-        }
-
-        exec { 'import icinga gpg key':
-          path      => '/bin:/usr/bin:/sbin:/usr/sbin',
-          command   => 'rpm --import /etc/pki/GPG-KEY-icinga',
-          unless    => "rpm -q gpg-pubkey-`echo $(gpg --throw-keyids < /etc/pki/GPG-KEY-icinga) | cut --characters=11-18 | tr [A-Z] [a-z]`",
-          require   => File['/etc/pki/GPG-KEY-icinga'],
-          logoutput => 'on_failure',
-        }
-
-        case $::operatingsystem {
-          'SLES': {
-            zypprepo { 'icinga-stable-release':
-              baseurl  => "http://packages.icinga.com/SUSE/${::operatingsystemrelease}/release/",
-              enabled  => 1,
-              gpgcheck => 1,
-              require  => Exec['import icinga gpg key']
-            }
-          }
-          default: {
-            fail('Your plattform is not supported to manage a repository.')
-          }
-        }
-      }
-      'windows': {
-        warning("The Icinga Project doesn't offer chocolaty packages at the moment.")
-      }
-      default: {
-        fail('Your plattform is not supported to manage a repository.')
-      }
+        },
+        require  => Class['::apt::backports'],
+        notify   => Exec['apt_update_icinga2'],
     }
 
-  } # if $::icinga::manage_repo
-
+    # First installs can trip without this
+    exec {'apt_update_icinga2':
+      command     => '/usr/bin/apt-get update',
+      refreshonly => true,
+      logoutput   => true,
+    }
 }
diff --git a/modules/icinga2/manifests/service.pp b/modules/icinga2/manifests/service.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/metadata.json b/modules/icinga2/metadata.json
old mode 100644
new mode 100755
index cff77b22..d5aa9c37
--- a/modules/icinga2/metadata.json
+++ b/modules/icinga2/metadata.json
@@ -1,6 +1,6 @@
 {
   "name": "icinga-icinga2",
-  "version": "1.3.3",
+  "version": "1.3.6",
   "author": "Icinga Development Team",
   "summary": "Icinga 2 Puppet Module",
   "license": "Apache-2.0",
@@ -13,7 +13,7 @@
   ],
   "dependencies": [
     { "name": "puppetlabs/stdlib", "version_requirement": ">= 4.16.0 < 5.0.0" },
-    { "name": "puppetlabs/concat", "version_requirement": ">= 2.0.1 < 5.0.0" }
+    { "name": "puppetlabs/concat", "version_requirement": ">= 2.1.0 < 5.0.0" }
   ],
   "operatingsystem_support": [
     {
diff --git a/modules/icinga2/serverspec/.rspec b/modules/icinga2/serverspec/.rspec
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/Rakefile b/modules/icinga2/serverspec/Rakefile
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/Vagrantfile b/modules/icinga2/serverspec/Vagrantfile
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/environments/production/Puppetfile b/modules/icinga2/serverspec/environments/production/Puppetfile
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/environments/production/environment.conf b/modules/icinga2/serverspec/environments/production/environment.conf
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/environments/production/manifests/default.pp b/modules/icinga2/serverspec/environments/production/manifests/default.pp
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/hiera.yaml b/modules/icinga2/serverspec/hiera.yaml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2debian7puppet4.sh b/modules/icinga2/serverspec/scripts/i2debian7puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2debian8puppet4.sh b/modules/icinga2/serverspec/scripts/i2debian8puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2freebsd10puppet4.sh b/modules/icinga2/serverspec/scripts/i2freebsd10puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2freebsd11puppet4.sh b/modules/icinga2/serverspec/scripts/i2freebsd11puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2oracle7puppet4.sh b/modules/icinga2/serverspec/scripts/i2oracle7puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2rhel6puppet4.sh b/modules/icinga2/serverspec/scripts/i2rhel6puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2rhel7puppet4.sh b/modules/icinga2/serverspec/scripts/i2rhel7puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2sles12sp2puppet4.sh b/modules/icinga2/serverspec/scripts/i2sles12sp2puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2ubuntu14puppet4.sh b/modules/icinga2/serverspec/scripts/i2ubuntu14puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2ubuntu16puppet4.sh b/modules/icinga2/serverspec/scripts/i2ubuntu16puppet4.sh
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/scripts/i2w2k12r2puppet4.bat b/modules/icinga2/serverspec/scripts/i2w2k12r2puppet4.bat
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2debian7puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2debian7puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2debian8puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2debian8puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2freebsd10puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2freebsd10puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2freebsd11puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2freebsd11puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2oracle7puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2oracle7puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2rhel6puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2rhel6puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2rhel7puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2rhel7puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2sles12sp2puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2sles12sp2puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2ubuntu14puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2ubuntu14puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/i2ubuntu16puppet4/plattform_independent_spec.rb b/modules/icinga2/serverspec/spec/i2ubuntu16puppet4/plattform_independent_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/serverspec/spec/spec_helper.rb b/modules/icinga2/serverspec/spec/spec_helper.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/api_spec.rb b/modules/icinga2/spec/classes/api_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/ca_spec.rb b/modules/icinga2/spec/classes/ca_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/checker_spec.rb b/modules/icinga2/spec/classes/checker_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/command_spec.rb b/modules/icinga2/spec/classes/command_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/compatlog_spec.rb b/modules/icinga2/spec/classes/compatlog_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/config_spec.rb b/modules/icinga2/spec/classes/config_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/debuglog_spec.rb b/modules/icinga2/spec/classes/debuglog_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/gelf_spec.rb b/modules/icinga2/spec/classes/gelf_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/graphite_spec.rb b/modules/icinga2/spec/classes/graphite_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/idomysql_spec.rb b/modules/icinga2/spec/classes/idomysql_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/idopgsql_spec.rb b/modules/icinga2/spec/classes/idopgsql_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/influxdb_spec.rb b/modules/icinga2/spec/classes/influxdb_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/init_spec.rb b/modules/icinga2/spec/classes/init_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/livestatus_spec.rb b/modules/icinga2/spec/classes/livestatus_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/mainlog_spec.rb b/modules/icinga2/spec/classes/mainlog_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/notification_spec.rb b/modules/icinga2/spec/classes/notification_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/opentsdb_spec.rb b/modules/icinga2/spec/classes/opentsdb_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/perfdata_spec.rb b/modules/icinga2/spec/classes/perfdata_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/repo_spec.rb b/modules/icinga2/spec/classes/repo_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/service_spec.rb b/modules/icinga2/spec/classes/service_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/statusdata_spec.rb b/modules/icinga2/spec/classes/statusdata_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/classes/syslog_spec.rb b/modules/icinga2/spec/classes/syslog_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/default_facts.yml b/modules/icinga2/spec/default_facts.yml
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/apiuser_spec.rb b/modules/icinga2/spec/defines/apiuser_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/checkcommand_spec.rb b/modules/icinga2/spec/defines/checkcommand_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/checkresultreader_spec.rb b/modules/icinga2/spec/defines/checkresultreader_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/compatlogger_spec.rb b/modules/icinga2/spec/defines/compatlogger_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/dependency_spec.rb b/modules/icinga2/spec/defines/dependency_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/endpoint_spec.rb b/modules/icinga2/spec/defines/endpoint_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/eventcommand_spec.rb b/modules/icinga2/spec/defines/eventcommand_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/feature_spec.rb b/modules/icinga2/spec/defines/feature_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/fragment_spec.rb b/modules/icinga2/spec/defines/fragment_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/host_spec.rb b/modules/icinga2/spec/defines/host_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/hostgroup_spec.rb b/modules/icinga2/spec/defines/hostgroup_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/notification_spec.rb b/modules/icinga2/spec/defines/notification_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/notificationcommand_spec.rb b/modules/icinga2/spec/defines/notificationcommand_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/object_spec.rb b/modules/icinga2/spec/defines/object_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/scheduleddowntime_spec.rb b/modules/icinga2/spec/defines/scheduleddowntime_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/service_spec.rb b/modules/icinga2/spec/defines/service_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/servicegroup_spec.rb b/modules/icinga2/spec/defines/servicegroup_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/timeperiod_spec.rb b/modules/icinga2/spec/defines/timeperiod_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/user_spec.rb b/modules/icinga2/spec/defines/user_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/usergroup_spec.rb b/modules/icinga2/spec/defines/usergroup_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/defines/zone_spec.rb b/modules/icinga2/spec/defines/zone_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/spec_helper.rb b/modules/icinga2/spec/spec_helper.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/unit/facter/util/fact_icinga2_puppet_hostcert_spec.rb b/modules/icinga2/spec/unit/facter/util/fact_icinga2_puppet_hostcert_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/unit/facter/util/fact_icinga2_puppet_hostprivkey_spec.rb b/modules/icinga2/spec/unit/facter/util/fact_icinga2_puppet_hostprivkey_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/spec/unit/facter/util/fact_icinga2_puppet_localcacert_spec.rb b/modules/icinga2/spec/unit/facter/util/fact_icinga2_puppet_localcacert_spec.rb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/templates/bot/irc.py b/modules/icinga2/templates/bot/irc.py
old mode 100644
new mode 100755
diff --git a/modules/icinga2/templates/icinga2.conf.erb b/modules/icinga2/templates/icinga2.conf.erb
old mode 100644
new mode 100755
index d206d938..c00d48a6
--- a/modules/icinga2/templates/icinga2.conf.erb
+++ b/modules/icinga2/templates/icinga2.conf.erb
@@ -38,12 +38,14 @@ include <<%= p %>>
  * the features-enabled directory.
  */
 include "features-enabled/*.conf"
+<% if @repositoryd -%>
 
 /**
  * The repository.d directory contains all configuration objects
  * managed by the 'icinga2 repository' CLI commands.
  */
 include_recursive "repository.d"
+<% end -%>
 
 <% if @confd -%>
 /**
diff --git a/modules/icinga2/templates/object.conf.erb b/modules/icinga2/templates/object.conf.erb
old mode 100644
new mode 100755
diff --git a/modules/icinga2/templates/ssl-phabricator.py b/modules/icinga2/templates/ssl-phabricator.py
deleted file mode 100644
index 92702cd3..00000000
--- a/modules/icinga2/templates/ssl-phabricator.py
+++ /dev/null
@@ -1,225 +0,0 @@
-#!/usr/bin/env python
-# Original by Riccardo Coccioli (volans) [https://raw.githubusercontent.com/wikimedia/operations-puppet/production/modules/icinga/files/raid_handler.py]
-"""Icinga Event Handler for SSL checks"""
-
-import argparse
-import datetime
-import logging
-import subprocess
-import socket
-import ssl
-import time
-import zlib
-
-from logging.handlers import RotatingFileHandler
-from phabricator import Phabricator
-
-SERVICE_STATES = ('OK', 'UNKNOWN', 'WARNING', 'CRITICAL')
-SERVICE_STATE_TYPES = ('SOFT', 'HARD')
-
-SKIP_STRINGS = ('timeout', 'timed out', 'connection refused', 'out of bounds')
-
-LOG_PATH = '/var/log/icinga/ssl_handler.log'
-COMMAND_FILE = '/var/lib/nagios/rw/nagios.cmd'
-
-ACK_MESSAGE = 'SSL handler auto-ack: {}'
-ICINGA_URL = ('https://icinga.miraheze.org/cgi-bin/icinga/extinfo.cgi?type=2&'
-              'host={host}&service={service}')
-
-PHABRICATOR_TASK_TITLE = "Certificate expiring on {service}"
-PHABRICATOR_TASK_DESCRIPTION_PREFIX = (
-    "TASK AUTO-GENERATED by Icinga SSL event handler\n\n"
-    "The [[ {url} | SSL certificate ]] for domain `{service}` is expiring.\n\n"
-    "Included below is the expiration date provided by a HTTP check on the domain.\n\n"
-    "Please handle the request as soon as possible."
-)
-
-logger = logging.getLogger('ssl_handler')
-
-
-def parse_args():
-    """Parse command line arguments"""
-
-    parser = argparse.ArgumentParser(
-        description='Icinga event handler for SSL checks')
-    parser.add_argument(
-        '-s', dest='service_state', action='store', required=True,
-        choices=SERVICE_STATES, help='Icinga service state')
-    parser.add_argument(
-        '-t', dest='service_state_type', action='store', required=True,
-        choices=SERVICE_STATE_TYPES, help='Icinga service state type')
-    parser.add_argument(
-        '-a', dest='service_attempts', action='store', required=True, type=int,
-        help='Icinga service retry attemp counter')
-    parser.add_argument(
-        '-H', dest='host_address', action='store', required=True,
-        help='Hostname/address of the monitored host')
-    parser.add_argument(
-        '-D', dest='service_description', action='store', required=True,
-        help='The Icinga service description')
-    parser.add_argument(
-        '-m', dest='message', action='store', required=True,
-        help='The service Status information output (first line)')
-    parser.add_argument(
-        '-d', dest='debug', action='store_true', help='Debug level logging')
-
-    return parser.parse_args()
-
-
-def get_ssl_status(service):
-    """ Get and return the SSL status of a domain.
-
-        Arguments:
-        service      -- domain of the certificate
-    """
-    ssl_date_fmt = r'%b %d %H:%M:%S %Y %Z'
-
-    context = ssl.create_default_context()
-    conn = context.wrap_socket(
-        socket.socket(socket.AF_INET),
-        server_hostname=service)
-    conn.settimeout(3.0)
-
-    conn.connect((service, 443))
-    ssl_info = conn.getpeercert()
-    status = datetime.datetime.strptime(ssl_info['notAfter'], ssl_date_fmt)
-
-    logger.debug(status)
-    return status
-
-
-def get_phabricator_client():
-    """Return a Phabricator client instance"""
-
-    client = Phabricator(
-        username = 'miraheze-icinga',
-        token = '<%= @icingabot_password %>',
-        host = 'https://phabricator.miraheze.org/api/'
-    )
-
-    return client
-
-
-def get_phabricator_project_ids(phab_client):
-    """ Return a list of Phabricator's projectPHID
-
-        Find the project IDs of the SSL tag and add the one of
-        Operations project.
-
-        Arguments:
-        phab_client -- a Phabricator client instance
-    """
-
-    projects = phab_client.project.query(names=['SSL', 'Operations'])
-
-    logger.debug("Found PHIDs '{}' for SSL and Operations".format(
-        projects.data.keys()))
-
-    return projects.data.keys()
-
-
-def open_phabricator_task(
-        phab_client, project_ids, service, ssl_status, icinga_url):
-    """ Open a task on Phabricator and return it
-
-        Arguments:
-        phab_client -- a Phabricator client instance
-        project_ids -- the PHIDs to tag the task with
-        service        -- the domain of the affected certificate
-        ssl_status  -- the SSL expiry date found by a python check
-        icinga_url  -- the URL of the Icinga alarm that triggered this handler
-    """
-
-    description_prefix = PHABRICATOR_TASK_DESCRIPTION_PREFIX.format(
-        service=service, url=icinga_url)
-    description = '{description_prefix}\n```\n{ssl_status}\n```'.format(
-        description_prefix=description_prefix, ssl_status=ssl_status)
-
-    task = phab_client.maniphest.createtask(
-        title=PHABRICATOR_TASK_TITLE.format(service=service),
-        projectPHIDs=project_ids, priority='75', description=description)
-
-    logger.debug('Opened Phabricator task: {}'.format(task))
-    return task
-
-
-def acknowledge_nagios_alert(host, service_description, task_uri):
-    """ Acknowledge the Icinga alert
-
-        Arguments:
-        host                -- the host
-        service_description -- the Icinga service description
-        task_uri            -- the URI of the related Phabricator task
-    """
-
-    message = (
-        '[{time}] ACKNOWLEDGE_SVC_PROBLEM;{host};{service};2;1;0;'
-        'nagiosadmin;{message}\n'
-    ).format(time=int(time.time()), host=host, service=service_description,
-             message=ACK_MESSAGE.format(task_uri))
-
-    with open(COMMAND_FILE, 'w') as f:
-        f.write(message)
-
-    logger.debug('Acknowledged Nagios/Icinga alert: {}'.format(message))
-
-
-def main():
-    """Run the Icinga Event Handler for SSL checks"""
-
-    args = parse_args()
-
-    log_formatter = logging.Formatter(
-        fmt='%(asctime)s [%(levelname)s] %(name)s::%(funcName)s: %(message)s',
-        datefmt='%F %T')
-    log_handler = RotatingFileHandler(
-        LOG_PATH, maxBytes=5*(1024**2), backupCount=10)
-    log_handler.setFormatter(log_formatter)
-    logger.addHandler(log_handler)
-    logger.raiseExceptions = False
-    logger.setLevel(logging.INFO)
-
-    if args.debug:
-        logger.setLevel(logging.DEBUG)
-
-    logger.debug('SSL Handler called with args: {}'.format(args))
-
-    if args.service_state == 'OK' or args.service_state_type != 'HARD':
-        logger.debug('Nothing to do, exiting')
-        return
-
-    message_lower = args.message.lower()
-    for skip_string in SKIP_STRINGS:
-        if skip_string in message_lower:
-            logger.info(
-                ("Skipping SSL Handler execution for host '{}' and "
-                 "skip string '{}' detected in '{}'").format(
-                    args.service_description, skip_string,
-                    args.message))
-            return
-
-    ssl_status = get_ssl_status(args.service_description)
-    phab_client = get_phabricator_client()
-    project_ids = get_phabricator_project_ids(phab_client)
-
-    icinga_url = ICINGA_URL.format(
-        host=args.host_address, service=args.service_description)
-    task = open_phabricator_task(
-        phab_client, project_ids, args.service_description, ssl_status, icinga_url)
-
-    acknowledge_nagios_alert(
-        args.host_address, args.service_description, task['uri'])
-
-    logger.info(
-        ("SSL Handler executed for host '{}'. "
-         "Created task ID '{}'").format(
-            args.service_description, task['id']))
-
-    logger.debug('SSL Handler completed')
-
-
-if __name__ == '__main__':
-    try:
-        main()
-    except Exception:
-        logger.exception("Unable to handle SSL check alert")
diff --git a/modules/icinga2/templates/ssl.conf b/modules/icinga2/templates/ssl.conf
deleted file mode 100644
index a334b9a5..00000000
--- a/modules/icinga2/templates/ssl.conf
+++ /dev/null
@@ -1,29 +0,0 @@
-apply Service "wc.miraheze.org" {
-  import "generic-service"
-  check_command = "check_ssl_expire"
-  vars.host = "miraheze.org"
-  vars.time = "30"
-
-  assign where "sslchecks" in host.groups
-}
-
-apply Service "phab.miraheze.wiki" {
-  import "generic-service"
-  check_command = "check_ssl_expire"
-  vars.host = "phab.miraheze.wiki"
-  vars.time = "15"
-
-  assign where "sslchecks" in host.groups
-}
-
-<% @sslcerts.each_pair do | name, property | -%>
-apply Service "<%= property['url'] %> - <%= property['ca'] %>" {
-  import "generic-service"
-  check_command = "check_ssl_expire"
-  vars.host = "<%= property['url'] %>"
-  vars.time = "<% if property['ca'] == "LetsEncrypt" %>15<% else %>30<% end %>"
-  event_command = "create_ssl_phabricator_ticket"
-
-  assign where "sslchecks" in host.groups
-}
-<% end -%>
